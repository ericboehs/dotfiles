# vim
[[ $OSTYPE = 'darwin'* ]] && alias vim='/Applications/MacVim.app/Contents/MacOS/Vim'

# bundle exec
alias b='bundle'
alias be='bundle exec'
alias bip='bundle install --path .bundle'

# tmux ssh agent forwarding hack
alias safix='export SSH_AUTH_SOCK=$(find /tmp/ssh-* -user $(whoami) -name agent\* 2>/dev/null |tail -1)'
sasw()  { export SSH_AUTH_SOCK=/tmp/ssh-agent-$1-screen }
saswa() { ln -nfs /tmp/ssh-agent-$1-screen /tmp/ssh-agent-$USER-screen }

# tmuxme pair function
tmuxme() { tmux -S /var/tmux/pairing attach -t $1 || tmux -S /var/tmux/pairing new-session -s $1 -t $2 || (tmux -S /var/tmux/pairing new-session -s $2 -d && tmux -S /var/tmux/pairing new-session -s $1 -t $2) }

# named directories
export c=~/Code

# cd
alias ..='cd ..'

# ls
# Find the option for using colir in ls
ls --color -d . &>/dev/null 2>&1 && alias ls='ls --color=tty' || alias ls='ls -G'
alias l="ls -lahF"
alias ll="ls -l"
alias la='ls -A'

# Git
which -s hub >/dev/null 2>&1 && alias git='hub'
alias gl='git pull'
alias gp='git push'
alias gd='git diff'
alias gc='git commit'
alias gcv='git commit -v'
alias gca='git commit -a'
alias gcav='git commit -av'
alias gcane='git commit --amend --no-edit'
alias gcaane='git commit -a --amend --no-edit'
alias gcp='git commit -av && git push'
alias gco='git checkout'
alias gcl='git clone'
alias gb='git branch'
alias gba='git branch -a'
alias gs='git status'
alias gst='git status'
alias gst='git status'
gra() { git remote add ${2:-"origin"} $1 }
grah() { git remote add $2 git@heroku.personal:$1.git }
alias grv='git remote -v'
alias grrm='git remote rm'
glrm() { git pull-request -b ${1}:master }
alias gsu="git submodule update --init --recursive"
alias changelog='git log $(git log -1 --format=%H -- CHANGELOG*)..; cat CHANGELOG*'

alias gdp='PROD_SHA=`curl -Is http://www.jerky.com | grep X-GitSHA | cut -d " " -f2`; git diff $PROD_SHA...master'
alias gsbp='PROD_SHA=`curl -Is http://www.jerky.com | grep X-GitSHA | cut -d " " -f2`; git show-branch $PROD_SHA master'
alias watup="watch -t 'echo \"app1: \`curl -Is www.jerky.com.app1.shops.com | grep Git | cut -d\  -f2\`\" && echo \"app2: \`curl -Is www.jerky.com.app2.shops.com | grep Git | cut -d\  -f2\`\" && echo \"head: \`git ls-remote git@github.comigimedia/digistore_new.git | head -1 |  tr -d \"\011HEAD\"\`\"'"

# Heroku
alias h='heroku'
hs() { heroku $@ -r staging }
hp() { heroku $@ -r production }

# Rails
alias tlog='tail -f log/development.log'

# Ruby
# Get latest stable gem version for a gem
gemv() { curl -s https://rubygems.org/api/v1/versions/$1.json | python -mjson.tool | grep number | head -1 | cut -d '"' -f4 }

# Xcode
alias xc='open /Developer/Applications/Xcode.app'
alias xc.='open *.xcodeproj'

# TextMate
alias m='mate'
alias m.='mate .'

# Finder
alias o.='open .'

# Misc
alias utime="ruby -e 'puts Time.now.to_i'"
alias sha1="/usr/bin/openssl sha1"

# PostgreSQL
alias pg_start="pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start"
alias pg_stop="pg_ctl -D /usr/local/var/postgres stop -s -m fast"

# Nginx
alias nr="sudo nginx -s reload"

# Chef
alias kcsd='knife cookbook site download'
alias kcsv='knife cookbook site vendor'
alias kcu='knife cookbook upload'
alias kes='knife ec2 server'
alias kesl='knife ec2 server list'

# Memcache
alias mem='memcached -d'

# Redis
alias redstart='redis-server /usr/local/etc/redis.conf'

# MongoDB
alias monstart='mongod run --config /usr/local/Cellar/mongodb/2.0.1-x86_64/mongod.conf'

# Misc
alias ee='eval $(cat .env)'
alias json="python -mjson.tool"
alias xml="xmllint --format -"
alias topmem='ps ax -eo pmem,pcpu,rss,vsize,args | sort -k 1 -r | head'
alias matemod='mate $(gst | grep modified | cut -d ":" -f 2)' #Edit git modified files in a textmate project
alias lb='open -a LaunchBar'

alias ejh='export JAVA_HOME="/System/Library/Frameworks/JavaVM.framework/Home"'

alias x=exit
alias cl=clear
alias vi='vim'
alias dv='dirs -v'
alias hist='history -rd'
alias zc='zcalc'

## Pipe Aliases (Global)
alias -g L='|less'
alias -g G='|grep'
alias -g T='|tail'
alias -g H='|head'
alias -g W='|wc -l'
alias -g S='|sort'
alias -g K='|ruby -e "require %Q(open-uri); puts URI::encode STDIN.read" | while read i; do kiku $i; done'

# directory aliases
# use like: ls ~src OR ~src OR du -h ~src
c=~/Code

# Redirect output to kikuchat
kiku() {
  curl -s -X POST -H "Accept: application/json" -d "message=$@" http://$KIKUCHAT_USER:$KIKUCHAT_API_KEY@kikuchat.brightb.it/room/1/messages.json > /dev/null
}

# Hitch
hitch() {
  command hitch "$@"
  if [[ -s "$HOME/.hitch_export_authors" ]] ; then source "$HOME/.hitch_export_authors" ; fi
}
alias unhitch='hitch -u'


#######################
# BUNDLE EXEC ALIASES
#######################

# The following is based on https://github.com/robbyrussell/oh-my-zsh/blob/master/plugins/bundler/bundler.plugin.zsh

bundled_commands=(annotate cap capify cucumber ey foreman guard heroku middleman nanoc rackup rainbows rails rake rspec ruby shotgun spec spork thin thor unicorn unicorn_rails)

_bundler-installed() {
  which bundle > /dev/null 2>&1
}

_within-bundled-project() {
  local check_dir=$PWD
  while [ $check_dir != "/" ]; do
    [ -f "$check_dir/Gemfile" ] && return
    check_dir="$(dirname $check_dir)"
  done
  false
}

_run-with-bundler() {
  if _bundler-installed && _within-bundled-project; then
    bundle exec $@
  else
    $@
  fi
}

for cmd in $bundled_commands; do
  eval "function bundled_$cmd () { _run-with-bundler $cmd \$@}"
  alias $cmd=bundled_$cmd

  if which _$cmd > /dev/null 2>&1; then
        compdef _$cmd bundled_$cmd=$cmd
  fi
done


#! /usr/bin/env bash
# Internet Connection Diagnostic Script for Mac with Extended Testing

# Define ANSI color codes for nice output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
NC='\033[0m' # No Color

# Global flag to track if all initial tests pass (no packet loss)
all_good=1

# Function to perform a ping test with a configurable packet count
ping_test() {
    local target="$1"
    local description="$2"
    local count="$3"

    echo -e "${YELLOW}Pinging ${description} (${target}) with ${count} packets...${NC}"
    # Capture the output of the ping command
    result=$(ping -c "$count" "$target" 2>&1)

    # Extract the packet loss percentage from the ping summary
    loss=$(echo "$result" | awk -F', ' '/packet loss/ {print $3}' | awk '{print $1}')

    if [ -z "$loss" ]; then
        echo -e "${RED}✖ Error: Unable to parse ping result for ${description}.${NC}"
        all_good=0
    else
        if [[ "$loss" != "0%" && "$loss" != "0.0%" ]]; then
            echo -e "${RED}✖ Warning: Packet loss detected: ${loss}.${NC}"
            all_good=0
        else
            echo -e "${GREEN}✔ Success: No packet loss detected: ${loss}.${NC}"
        fi
    fi

    echo -e "${BLUE}--------------------------------------------${NC}"
    echo ""
}

# Print header banner
echo -e "${BLUE}============================================"
echo -e "      Internet Connection Diagnostic"
echo -e "============================================${NC}"
echo ""

# Define targets and descriptions
declare -A targets
targets["10.0.1.1"]="Router"
targets["1.1.1.1"]="Cloudflare DNS (1.1.1.1)"
targets["google.com"]="Google (DNS test)"

# --- Initial Testing (4 packets each) ---
echo -e "${BLUE}Starting initial tests...${NC}"
for target in "${!targets[@]}"; do
    ping_test "$target" "${targets[$target]}" 4
done

# --- Extended Testing if Initial Tests are Good ---
if [ $all_good -eq 1 ]; then
    echo -e "${BLUE}All initial tests passed with no packet loss.${NC}"
    echo -e "${BLUE}Running extended tests (20 packets each)...${NC}"
    echo ""
    for target in "${!targets[@]}"; do
        ping_test "$target" "${targets[$target]}" 20
    done
else
    echo -e "${YELLOW}Some issues were detected in the initial tests. Skipping extended testing.${NC}"
fi

echo -e "${BLUE}Diagnostic complete.${NC}"
